# 需求文档

## 简介

本文档定义了智能小车高速寻迹系统的需求。该系统使用8路灰度传感器阵列和MPU6050惯性测量单元，在高速状态下跟随黑色轨迹线。赛道由直线段和钝角弯道（>120度）组成。系统必须在直线段保持稳定，同时安全地通过弯道。

## 术语表

- **寻迹系统**: 控制智能小车跟随赛道黑线的完整软件系统
- **灰度传感器阵列**: 8路传感器阵列，用于检测黑线相对于小车的位置
- **MPU6050**: 6轴惯性测量单元，包含3轴陀螺仪和3轴加速度计
- **位置误差**: 根据灰度传感器读数计算出的小车偏离黑线中心的偏差值
- **陀螺仪阻尼**: 从陀螺仪Z轴角速度导出的控制信号，用于抑制震荡
- **PID控制器**: 比例-积分-微分控制器，根据位置误差计算转向修正量
- **转向输出**: 发送到电机驱动器的最终控制信号，用于调整小车方向
- **基础速度**: 小车的目标前进速度，根据赛道条件变化
- **钝角弯道**: 角度大于120度的转弯（相对平缓的弯道）
- **震荡**: 小车在循迹过程中不希望出现的左右摇摆运动

## 需求

### 需求 1

**用户故事:** 作为智能小车操作者，我希望系统使用8路灰度传感器阵列准确检测线位置，以便小车能够精确跟随赛道。

#### 验收标准

1. WHEN 读取灰度传感器时 THEN 寻迹系统 SHALL 计算一个加权位置值，表示黑线相对于传感器阵列的位置
2. WHEN 黑线位于传感器阵列正中心时 THEN 寻迹系统 SHALL 输出位置值为零
3. WHEN 黑线偏向左侧或右侧时 THEN 寻迹系统 SHALL 输出与偏移距离成比例的负值或正值位置值
4. WHEN 多个传感器同时检测到黑线时 THEN 寻迹系统 SHALL 使用加权平均算法计算位置
5. WHEN 所有传感器都未检测到黑线时 THEN 寻迹系统 SHALL 保持最后已知的位置值并进入丢线状态

### 需求 2

**用户故事:** 作为智能小车操作者，我希望系统在高速状态下保持稳定的直线跟踪，以便小车不会震荡或偏离路径。

#### 验收标准

1. WHEN 小车处于直线段时 THEN 寻迹系统 SHALL 基于位置误差应用PID控制来生成转向修正量
2. WHEN 小车处于直线段时 THEN 寻迹系统 SHALL 读取MPU6050陀螺仪Z轴角速度并应用陀螺仪阻尼来抑制震荡
3. WHEN 陀螺仪在直线段检测到非零角速度时 THEN 寻迹系统 SHALL 在相反方向施加与角速度成比例的阻尼力
4. WHEN 计算最终转向输出时 THEN 寻迹系统 SHALL 将PID控制器输出与陀螺仪阻尼信号结合
5. WHEN 小车在直线跟踪时 THEN 寻迹系统 SHALL 将基础速度保持在高水平（最大速度的70-85%）

### 需求 3

**用户故事:** 作为智能小车操作者，我希望系统能够检测并安全通过钝角弯道，以便小车能够完成赛道而不丢线。

#### 验收标准

1. WHEN 位置误差持续超过预定义阈值时 THEN 寻迹系统 SHALL 将该状况识别为钝角弯道
2. WHEN 检测到钝角弯道时 THEN 寻迹系统 SHALL 将基础速度降低到安全转弯速度（最大速度的55-65%）
3. WHEN 通过钝角弯道时 THEN 寻迹系统 SHALL 主要使用基于灰度的PID控制器进行转向
4. WHEN 通过钝角弯道时 THEN 寻迹系统 SHALL 降低陀螺仪阻尼系数以允许更大的角速度
5. WHEN 转弯后位置误差恢复到低值时 THEN 寻迹系统 SHALL 逐渐将基础速度提升回直线速度

### 需求 4

**用户故事:** 作为智能小车操作者，我希望系统使用MPU6050在转弯时监测侧向加速度，以便小车不会超过安全转弯极限。

#### 验收标准

1. WHEN 小车处于钝角弯道时 THEN 寻迹系统 SHALL 读取MPU6050加速度计Y轴值来测量侧向加速度
2. WHEN 侧向加速度超过安全阈值时 THEN 寻迹系统 SHALL 降低基础速度以防止失去抓地力
3. WHEN 侧向加速度在安全范围内时 THEN 寻迹系统 SHALL 保持当前转弯速度
4. WHEN 陀螺仪Z轴角速度超过异常阈值时 THEN 寻迹系统 SHALL 检测到潜在的打滑状况并降低速度

### 需求 5

**用户故事:** 作为智能小车操作者，我希望系统根据跟踪误差动态调整速度，以便小车在需要修正时减速，在稳定路段时加速。

#### 验收标准

1. WHEN 位置误差的绝对值较小时 THEN 寻迹系统 SHALL 保持较高的基础速度
2. WHEN 位置误差的绝对值增大时 THEN 寻迹系统 SHALL 按误差大小成比例地降低基础速度
3. WHEN 计算动态速度时 THEN 寻迹系统 SHALL 使用公式：speed = base_speed - k * |位置误差|，其中k是可调系数
4. WHEN 速度计算结果低于最小阈值时 THEN 寻迹系统 SHALL 将速度限制在最小安全速度
5. WHEN 速度计算结果高于最大阈值时 THEN 寻迹系统 SHALL 将速度限制在最大安全速度

### 需求 6

**用户故事:** 作为智能小车操作者，我希望系统能够优雅地处理丢线情况，以便小车能够尝试恢复并继续跟踪。

#### 验收标准

1. WHEN 所有灰度传感器读数都表明未检测到线时 THEN 寻迹系统 SHALL 进入丢线状态
2. WHEN 进入丢线状态时 THEN 寻迹系统 SHALL 记录丢线前最后检测到黑线的传感器位置
3. WHEN 处于丢线状态时 THEN 寻迹系统 SHALL 将基础速度降低到较低的搜索速度
4. WHEN 丢线前黑线位于传感器阵列左侧（负位置误差）时 THEN 寻迹系统 SHALL 向左转向搜索线
5. WHEN 丢线前黑线位于传感器阵列右侧（正位置误差）时 THEN 寻迹系统 SHALL 向右转向搜索线
6. WHEN 丢线前黑线位于传感器阵列中心时 THEN 寻迹系统 SHALL 保持直行并根据陀螺仪数据判断转向趋势
7. WHEN 丢线后任何灰度传感器检测到线时 THEN 寻迹系统 SHALL 退出丢线状态并恢复正常跟踪
8. WHEN 丢线状况持续超过超时时间时 THEN 寻迹系统 SHALL 停止小车以防止不安全操作

### 需求 7

**用户故事:** 作为开发者，我希望系统提供可配置的PID和阻尼参数，以便可以针对不同的赛道条件和小车特性调整跟踪行为。

#### 验收标准

1. THE 寻迹系统 SHALL 提供可配置的PID增益参数（Kp、Ki、Kd）
2. THE 寻迹系统 SHALL 提供直线段的可配置陀螺仪阻尼系数（Kg）
3. THE 寻迹系统 SHALL 提供弯道段的可配置陀螺仪阻尼系数
4. THE 寻迹系统 SHALL 提供直线段和弯道的可配置速度阈值
5. THE 寻迹系统 SHALL 提供弯道检测和丢线检测的可配置误差阈值

### 需求 8

**用户故事:** 作为开发者，我希望系统以一致的高频率执行控制循环，以便小车能够快速响应线位置变化。

#### 验收标准

1. THE 寻迹系统 SHALL 以至少100 Hz的频率执行主控制循环
2. WHEN 读取传感器数据时 THEN 寻迹系统 SHALL 在控制循环周期内完成读取操作
3. WHEN 计算PID和阻尼输出时 THEN 寻迹系统 SHALL 在控制循环周期内完成所有计算
4. WHEN 更新电机控制信号时 THEN 寻迹系统 SHALL 在下一次控制循环迭代之前应用新的转向输出
5. THE 寻迹系统 SHALL 使用定时器中断或DMA来确保一致的循环时序

### 需求 9

**用户故事:** 作为智能小车操作者，我希望系统能够识别十字路口并保持直行，以便小车不会在十字路口处误判为弯道。

#### 验收标准

1. WHEN 灰度传感器阵列的多个连续传感器（至少5个）同时检测到黑线时 THEN 寻迹系统 SHALL 识别为十字路口
2. WHEN 识别到十字路口时 THEN 寻迹系统 SHALL 保持当前直行方向，忽略左右分支
3. WHEN 处于十字路口时 THEN 寻迹系统 SHALL 保持当前速度不减速
4. WHEN 处于十字路口时 THEN 寻迹系统 SHALL 使用陀螺仪阻尼保持车体姿态稳定
5. WHEN 传感器检测到的黑线宽度恢复正常时 THEN 寻迹系统 SHALL 退出十字路口状态并恢复正常跟踪

### 需求 10

**用户故事:** 作为调试人员，我希望通过蓝牙串口实时调整系统参数，以便在不重新编译代码的情况下优化小车性能。

#### 验收标准

1. WHEN 通过蓝牙串口接收到参数调整命令时 THEN 寻迹系统 SHALL 解析命令并更新对应的参数值
2. WHEN 参数更新成功时 THEN 寻迹系统 SHALL 通过蓝牙串口发送确认消息
3. WHEN 接收到参数查询命令时 THEN 寻迹系统 SHALL 通过蓝牙串口返回当前所有参数的值
4. THE 寻迹系统 SHALL 支持通过蓝牙串口调整PID参数（Kp、Ki、Kd）
5. THE 寻迹系统 SHALL 支持通过蓝牙串口调整陀螺仪阻尼系数（直线段Kg和弯道段Kg）
6. THE 寻迹系统 SHALL 支持通过蓝牙串口调整速度参数（直线速度、弯道速度、最小速度、最大速度）
7. THE 寻迹系统 SHALL 支持通过蓝牙串口调整阈值参数（弯道检测阈值、丢线检测阈值、侧向加速度阈值、十字路口检测阈值）
8. WHEN 接收到无效命令时 THEN 寻迹系统 SHALL 通过蓝牙串口返回错误消息
9. THE 寻迹系统 SHALL 使用简洁的文本协议格式，例如"SET PID_KP 1.5"或"GET ALL"
10. WHEN 小车运行时 THEN 寻迹系统 SHALL 能够在不停止运行的情况下实时更新参数
