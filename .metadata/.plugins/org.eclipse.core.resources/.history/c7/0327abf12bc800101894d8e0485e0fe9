#include "oled.h"
#include <stdio.h>

// 简化的8x16字体数据 (只包含数字0-9和字母A-Z)
const unsigned char OLED_Font8x16[] = {
    // 数字0-9 (ASCII 48-57)
    0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x0F,0x10,0x20,0x20,0x10,0x0F,0x00,//0
    0x00,0x10,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//1
    0x00,0x70,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x30,0x28,0x24,0x22,0x21,0x30,0x00,//2
    0x00,0x30,0x08,0x88,0x88,0x48,0x30,0x00,0x00,0x18,0x20,0x20,0x20,0x11,0x0E,0x00,//3
    0x00,0x00,0xC0,0x20,0x10,0xF8,0x00,0x00,0x00,0x07,0x04,0x24,0x24,0x3F,0x24,0x00,//4
    0x00,0xF8,0x08,0x88,0x88,0x08,0x08,0x00,0x00,0x19,0x21,0x20,0x20,0x11,0x0E,0x00,//5
    0x00,0xE0,0x10,0x88,0x88,0x18,0x00,0x00,0x00,0x0F,0x11,0x20,0x20,0x11,0x0E,0x00,//6
    0x00,0x38,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,//7
    0x00,0x70,0x88,0x08,0x08,0x88,0x70,0x00,0x00,0x1C,0x22,0x21,0x21,0x22,0x1C,0x00,//8
    0x00,0xE0,0x10,0x08,0x08,0x10,0xE0,0x00,0x00,0x00,0x31,0x22,0x22,0x11,0x0F,0x00,//9
    // 字母A-Z (ASCII 65-90)
    0x00,0x00,0xC0,0x38,0xE0,0x00,0x00,0x00,0x20,0x3C,0x23,0x02,0x02,0x27,0x38,0x20,//A
    0x08,0xF8,0x88,0x88,0x88,0x70,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x11,0x0E,0x00,//B
    0xC0,0x30,0x08,0x08,0x08,0x08,0x38,0x00,0x07,0x18,0x20,0x20,0x20,0x10,0x08,0x00,//C
    0x08,0xF8,0x08,0x08,0x08,0x10,0xE0,0x00,0x20,0x3F,0x20,0x20,0x20,0x10,0x0F,0x00,//D
    0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x20,0x23,0x20,0x18,0x00,//E
    0x08,0xF8,0x88,0x88,0xE8,0x08,0x10,0x00,0x20,0x3F,0x20,0x00,0x03,0x00,0x00,0x00,//F
    0xC0,0x30,0x08,0x08,0x08,0x38,0x00,0x00,0x07,0x18,0x20,0x20,0x22,0x1E,0x02,0x00,//G
    0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x20,0x3F,0x21,0x01,0x01,0x21,0x3F,0x20,//H
    0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0x00,0x00,0x20,0x20,0x3F,0x20,0x20,0x00,0x00,//I
    0x00,0x00,0x08,0x08,0xF8,0x08,0x08,0x00,0xC0,0x80,0x80,0x80,0x7F,0x00,0x00,0x00,//J
    0x08,0xF8,0x88,0xC0,0x28,0x18,0x08,0x00,0x20,0x3F,0x20,0x01,0x26,0x38,0x20,0x00,//K
    0x08,0xF8,0x08,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x20,0x20,0x20,0x20,0x30,0x00,//L
    0x08,0xF8,0xF8,0x00,0xF8,0xF8,0x08,0x00,0x20,0x3F,0x00,0x3F,0x00,0x3F,0x20,0x00,//M
    0x08,0xF8,0x30,0xC0,0x00,0x08,0xF8,0x08,0x20,0x3F,0x20,0x00,0x07,0x18,0x3F,0x00,//N
    0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x10,0x20,0x20,0x20,0x10,0x0F,0x00,//O
    0x08,0xF8,0x08,0x08,0x08,0x08,0xF0,0x00,0x20,0x3F,0x21,0x01,0x01,0x01,0x00,0x00,//P
    0xE0,0x10,0x08,0x08,0x08,0x10,0xE0,0x00,0x0F,0x18,0x24,0x24,0x38,0x50,0x4F,0x00,//Q
    0x08,0xF8,0x88,0x88,0x88,0x88,0x70,0x00,0x20,0x3F,0x20,0x00,0x03,0x0C,0x30,0x20,//R
    0x00,0x70,0x88,0x08,0x08,0x08,0x38,0x00,0x00,0x38,0x20,0x21,0x21,0x22,0x1C,0x00,//S
    0x18,0x08,0x08,0xF8,0x08,0x08,0x18,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,//T
    0x08,0xF8,0x08,0x00,0x00,0x08,0xF8,0x08,0x00,0x1F,0x20,0x20,0x20,0x20,0x1F,0x00,//U
    0x08,0x78,0x88,0x00,0x00,0xC8,0x38,0x08,0x00,0x00,0x07,0x38,0x0E,0x01,0x00,0x00,//V
    0xF8,0x08,0x00,0xF8,0x00,0x08,0xF8,0x00,0x03,0x3C,0x07,0x00,0x07,0x3C,0x03,0x00,//W
    0x08,0x18,0x68,0x80,0x80,0x68,0x18,0x08,0x20,0x30,0x2C,0x03,0x03,0x2C,0x30,0x20,//X
    0x08,0x38,0xC8,0x00,0xC8,0x38,0x08,0x00,0x00,0x00,0x20,0x3F,0x20,0x00,0x00,0x00,//Y
    0x10,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x20,0x38,0x26,0x21,0x20,0x20,0x18,0x00,//Z
};

// 软件I2C延时
static void I2C_Delay(void)
{
    volatile int i = 10;
    while(i--);
}

// I2C开始信号
static void I2C_Start(void)
{
    OLED_SDA_SET();
    OLED_SCL_SET();
    I2C_Delay();
    OLED_SDA_RESET();
    I2C_Delay();
    OLED_SCL_RESET();
    I2C_Delay();
}

// I2C停止信号
static void I2C_Stop(void)
{
    OLED_SDA_RESET();
    OLED_SCL_SET();
    I2C_Delay();
    OLED_SDA_SET();
    I2C_Delay();
}

// I2C发送一个字节
static void I2C_WriteByte(uint8_t data)
{
    for(int i = 0; i < 8; i++)
    {
        if(data & 0x80)
            OLED_SDA_SET();
        else
            OLED_SDA_RESET();
        
        I2C_Delay();
        OLED_SCL_SET();
        I2C_Delay();
        OLED_SCL_RESET();
        I2C_Delay();
        data <<= 1;
    }
    
    // ACK
    OLED_SDA_SET();
    I2C_Delay();
    OLED_SCL_SET();
    I2C_Delay();
    OLED_SCL_RESET();
    I2C_Delay();
}

// 发送命令
static void OLED_WriteCmd(uint8_t cmd)
{
    I2C_Start();
    I2C_WriteByte(0x78);  // OLED地址
    I2C_WriteByte(0x00);  // 命令模式
    I2C_WriteByte(cmd);
    I2C_Stop();
}

// 发送数据
static void OLED_WriteData(uint8_t data)
{
    I2C_Start();
    I2C_WriteByte(0x78);  // OLED地址
    I2C_WriteByte(0x40);  // 数据模式
    I2C_WriteByte(data);
    I2C_Stop();
}

// 设置光标位置
static void OLED_SetPos(uint8_t x, uint8_t y)
{
    OLED_WriteCmd(0xB0 + y);                    // 设置页地址
    OLED_WriteCmd(((x & 0xF0) >> 4) | 0x10);    // 设置列地址高4位
    OLED_WriteCmd((x & 0x0F) | 0x00);           // 设置列地址低4位
}

// 清屏
void OLED_Clear(void)
{
    for(int i = 0; i < 8; i++)
    {
        OLED_SetPos(0, i);
        for(int j = 0; j < 128; j++)
        {
            OLED_WriteData(0x00);
        }
    }
}

// 显示字符
static void OLED_ShowChar(uint8_t x, uint8_t y, char chr)
{
    int index = -1;
    
    // 查找字符索引
    if(chr >= '0' && chr <= '9')
        index = chr - '0';
    else if(chr >= 'A' && chr <= 'Z')
        index = chr - 'A' + 10;
    else if(chr >= 'a' && chr <= 'z')
        index = chr - 'a' + 10;  // 小写字母使用大写字母字模
    
    if(index >= 0)
    {
        // 显示字符上半部分
        OLED_SetPos(x, y);
        for(int i = 0; i < 8; i++)
            OLED_WriteData(OLED_Font8x16[index * 16 + i]);
        
        // 显示字符下半部分
        OLED_SetPos(x, y + 1);
        for(int i = 0; i < 8; i++)
            OLED_WriteData(OLED_Font8x16[index * 16 + i + 8]);
    }
}

// 显示字符串
void OLED_ShowString(uint8_t x, uint8_t y, char *str)
{
    while(*str != '\0')
    {
        OLED_ShowChar(x, y, *str);
        x += 8;
        if(x > 120) {x = 0; y += 2;}
        str++;
    }
}

// 显示数字
void OLED_ShowNum(uint8_t x, uint8_t y, uint32_t num)
{
    char str[12];
    sprintf(str, "%lu", num);
    OLED_ShowString(x, y, str);
}

// OLED初始化
void OLED_Init(void)
{
    GPIO_InitTypeDef GPIO_InitStruct = {0};
    
    // 使能GPIOB时钟
    __HAL_RCC_GPIOB_CLK_ENABLE();
    
    // 配置I2C引脚
    GPIO_InitStruct.Pin = OLED_SCL_PIN | OLED_SDA_PIN;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Pull = GPIO_PULLUP;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_HIGH;
    HAL_GPIO_Init(OLED_SCL_PORT, &GPIO_InitStruct);
    
    HAL_Delay(100);  // 等待OLED上电稳定
    
    // OLED初始化序列
    OLED_WriteCmd(0xAE); // 关闭显示
    OLED_WriteCmd(0xD5); // 设置时钟分频
    OLED_WriteCmd(0x80);
    OLED_WriteCmd(0xA8); // 设置多路复用
    OLED_WriteCmd(0x3F);
    OLED_WriteCmd(0xD3); // 设置显示偏移
    OLED_WriteCmd(0x00);
    OLED_WriteCmd(0x40); // 设置显示开始行
    OLED_WriteCmd(0x8D); // 充电泵设置
    OLED_WriteCmd(0x14);
    OLED_WriteCmd(0x20); // 设置内存地址模式
    OLED_WriteCmd(0x02);
    OLED_WriteCmd(0xA1); // 段重定义
    OLED_WriteCmd(0xC8); // COM扫描方向
    OLED_WriteCmd(0xDA); // COM引脚配置
    OLED_WriteCmd(0x12);
    OLED_WriteCmd(0x81); // 对比度设置
    OLED_WriteCmd(0xCF);
    OLED_WriteCmd(0xD9); // 预充电周期
    OLED_WriteCmd(0xF1);
    OLED_WriteCmd(0xDB); // VCOMH电压
    OLED_WriteCmd(0x30);
    OLED_WriteCmd(0xA4); // 全局显示开启
    OLED_WriteCmd(0xA6); // 正常显示
    OLED_WriteCmd(0xAF); // 开启显示
    
    OLED_Clear();
}

uint32_t oled_pow(uint8_t m, uint8_t n)
{
    uint32_t result = 1;
    while(n--) result *= m;
    return result;
}
