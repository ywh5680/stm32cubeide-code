#include "run.h"
#include "pid/pid.h" // Include pid.h

static int16_t run_base_speed = 400;
static Incremental_PID_TypeDef line_follow_pid; // Declare PID structure
static float accumulated_turn_output = 0.0f; // Accumulator for incremental PID output

static int16_t run_clamp_speed(int16_t speed)
{
    if (speed > 1000)
    {
        speed = 1000;
    }
    else if (speed < -1000)
    {
        speed = -1000;
    }
    return speed;
}

void Run_Init(void)
{
    Car_Move(0, 0);
    // Initialize the line following PID controller
    // Using example Kp, Ki, Kd values. Adjust as needed.
    // SetPoint is 0.0f as we want the error to be 0 (robot on the line).
    Incremental_PID_Init(&line_follow_pid, 0.0f, 80.0f, 0.0f, 50.0f);
    accumulated_turn_output = 0.0f; // Reset accumulator on init
}

void Run_SetBaseSpeed(int16_t speed)
{
    run_base_speed = speed;
}

void Run_LineFollowStep(void)
{
    uint8_t sensors = GRAY_ReadByte();
    static const int8_t weights[8] = {-4, -3, -2, -1, 1, 2, 3, 4};
    int16_t sum = 0;
    int16_t count = 0;

    for (int i = 0; i < 8; i++)
    {
        if (((sensors >> i) & 0x01U) == 0U)
        {
            sum += weights[i];
            count++;
        }
    }

    float error = 0.0f; // Default error if no sensors detect line
    if (count > 0)
    {
        error = (float)sum / (float)count;
    }

    // Calculate control output increment using incremental PID
    float control_delta = Incremental_PID_Calc(&line_follow_pid, error);
    
    // Accumulate the control delta to get the current turn value
    accumulated_turn_output += control_delta;

    // Clamp the accumulated_turn_output to prevent runaway values, if necessary
    // Example: if (accumulated_turn_output > MAX_TURN) accumulated_turn_output = MAX_TURN;
    //          else if (accumulated_turn_output < -MAX_TURN) accumulated_turn_output = -MAX_TURN;
    // For now, let's assume the PID tuning handles this, or that it's clamped implicitly by speed.

    int16_t turn = (int16_t)accumulated_turn_output;

    int16_t left_speed = run_clamp_speed(run_base_speed - turn);
    int16_t right_speed = run_clamp_speed(run_base_speed + turn);

    Car_Move(-left_speed, -right_speed);
}

